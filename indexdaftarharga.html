<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Kasir Pintar - Scan Barcode</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>

    <style>
        body {
            background: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)),
                url("https://images.unsplash.com/photo-1534723452862-4c874018d66d?q=80&w=2070&auto=format&fit=crop");
            background-size: cover; background-position: center; background-attachment: fixed;
            font-family: "Segoe UI", sans-serif; display: flex; flex-direction: column;
            align-items: center; padding: 40px 20px; min-height: 100vh; margin: 0;
        }

        .container {
            background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(15px);
            padding: 30px; border-radius: 20px; box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.2); width: 100%; max-width: 950px; margin-bottom: 30px;
        }

        h2, h3 { color: white; text-align: center; text-transform: uppercase; letter-spacing: 2px; margin-top: 0; }

        .top-menu { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; border-bottom: 1px solid rgba(255, 255, 255, 0.2); padding-bottom: 15px; }

        /* Area Kamera Scanner */
        #reader-container {
            display: none; margin-bottom: 20px; border: 3px solid #3498db;
            border-radius: 15px; overflow: hidden; background: #000;
        }

        .btn {
            padding: 10px 18px; border: none; border-radius: 8px; cursor: pointer;
            font-weight: bold; transition: 0.3s; font-size: 13px; display: flex; align-items: center; gap: 5px;
        }

        .btn-add { background: #2ecc71; color: white; }
        .btn-save { background: #f1c40f; color: #333; }
        .btn-edit { background: #3498db; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-scan { background: #9b59b6; color: white; }

        table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
        th { color: #eee; padding: 15px; text-align: left; }
        td { background: rgba(255, 255, 255, 0.95); padding: 12px 15px; color: #2c3e50; }
        td:first-child { border-radius: 10px 0 0 10px; }
        td:last-child { border-radius: 0 10px 10px 0; }

        .locked td:not(:last-child) { background: rgba(200, 200, 200, 0.9); cursor: not-allowed; }

        input { width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; }

        .total-box {
            background: #2ecc71; color: white; font-weight: bold; display: flex;
            align-items: center; justify-content: center; font-size: 18px;
            border-radius: 8px; height: 45px; width: 200px;
        }

        .label-kasir { color: white; font-weight: bold; min-width: 150px; }
    </style>
</head>
<body>

    <div class="container">
        <h2><u>WARUNG CS</u></h2>
        
        <div id="reader-container">
            <div id="reader"></div>
            <button class="btn btn-danger" style="width:100%; border-radius:0" onclick="stopScanner()">‚ùå TUTUP KAMERA</button>
        </div>

        <div class="top-menu">
            <button class="btn btn-add" onclick="tambahBarisInventaris()">‚ûï Tambah Barang Baru</button>
            <button class="btn btn-save" onclick="simpanDataInventaris()">üíæ Simpan Daftar</button>
            <button class="btn btn-edit" onclick="aktifkanEditInventaris()">‚úèÔ∏è Edit Data</button>
        </div>

        <table id="tabelMaster">
            <thead>
                <tr>
                    <th width="30%">Nama Barang</th>
                    <th width="20%">Harga (Rp)</th>
                    <th width="35%">No. Resi / Kode Barcode</th>
                    <th width="15%">Aksi</th>
                </tr>
            </thead>
            <tbody id="bodyTabel" class="locked"></tbody>
        </table>
    </div>

    <div class="container" style="border: 2px solid #f1c40f">
        <h3>RUANG KASIR</h3>
        <div class="top-menu">
            <button class="btn btn-add" onclick="tambahBarisKasir()">‚ûï Tambah Belanjaan</button>
            <button class="btn" style="background: #e67e22; color: white" onclick="cetakStrukIndomaret()">üõí Cetak Struk</button>
        </div>

        <table id="tabelKasir">
            <thead>
                <tr>
                    <th width="35%">Nama Barang / Barcode</th>
                    <th width="10%">Qty</th>
                    <th width="20%">Harga Satuan</th>
                    <th width="20%">Total</th>
                    <th width="15%">Aksi</th>
                </tr>
            </thead>
            <tbody id="bodyKasir">
                </tbody>
        </table>

        <div style="margin-top: 25px; display: flex; flex-direction: column; align-items: flex-end; gap: 10px;">
            <div style="display: flex; align-items: center; gap: 10px;">
                <span class="label-kasir">TOTAL BELANJA:</span>
                <div id="grandTotal" class="total-box">Rp 0</div>
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <span class="label-kasir">UANG BAYAR:</span>
                <input type="number" id="inputBayar" style="width: 200px; height: 45px; text-align: center; font-size: 18px; font-weight: bold;" oninput="hitungKembalian()" placeholder="0">
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <span class="label-kasir">KEMBALIAN:</span>
                <div id="uangKembali" class="total-box" style="background: #e74c3c;">Rp 0</div>
            </div>
        </div>
    </div>

    <script>
        let html5QrCode;
        let activeTargetInput = null;

        // --- LOGIKA SCANNER ---
        function startScanner(targetInput, callback) {
            activeTargetInput = targetInput;
            const container = document.getElementById("reader-container");
            container.style.display = "block";
            container.scrollIntoView({ behavior: 'smooth' });

            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: { width: 250, height: 150 } },
                (decodedText) => {
                    if (callback) {
                        callback(decodedText);
                    } else {
                        activeTargetInput.innerText = decodedText;
                    }
                    stopScanner();
                },
                (err) => {}
            ).catch(err => alert("Kamera Error: " + err));
        }

        function stopScanner() {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    document.getElementById("reader-container").style.display = "none";
                });
            }
        }

        // --- LOGIKA INVENTARIS ---
        function tambahBarisInventaris() {
            const body = document.getElementById("bodyTabel");
            body.classList.remove("locked");
            const row = body.insertRow(-1);
            row.innerHTML = `
                <td contenteditable="true"></td>
                <td contenteditable="true"></td>
                <td style="display:flex; gap:5px; align-items:center;">
                    <span class="barcode-val" contenteditable="true" style="flex:1"></span>
                    <button class="btn btn-scan" onclick="startScanner(this.parentElement.querySelector('.barcode-val'))">üì∑ Scan</button>
                </td>
                <td><button class="btn btn-danger" onclick="hapusBarisInventaris(this)">üóëÔ∏è Hapus</button></td>
            `;
        }

        function simpanDataInventaris() {
            const body = document.getElementById("bodyTabel");
            body.querySelectorAll("td:not(:last-child)").forEach(td => td.setAttribute("contenteditable", "false"));
            body.querySelectorAll(".barcode-val").forEach(span => span.setAttribute("contenteditable", "false"));
            body.classList.add("locked");
            localStorage.setItem("dataInventaris_V5", body.innerHTML);
            alert("‚úÖ Data Berhasil Disimpan!");
        }

        function aktifkanEditInventaris() {
            const body = document.getElementById("bodyTabel");
            body.classList.remove("locked");
            body.querySelectorAll("td:not(:last-child), .barcode-val").forEach(el => el.setAttribute("contenteditable", "true"));
            alert("‚úèÔ∏è Mode Edit Aktif.");
        }

        function hapusBarisInventaris(btn) {
            if(confirm("Hapus barang?")) btn.closest("tr").remove();
        }

        // --- LOGIKA KASIR ---
        function tambahBarisKasir() {
            const body = document.getElementById("bodyKasir");
            const row = body.insertRow(-1);
            row.innerHTML = `
                <td style="display:flex; gap:5px; align-items:center;">
                    <input type="text" class="input-kasir-nama" oninput="hitungTransaksi(this)" placeholder="Ketik Nama/Kode...">
                    <button class="btn btn-scan" onclick="prosesScanKasir(this)">üì∑ Scan</button>
                </td>
                <td><input type="number" class="input-kasir-jumlah" oninput="hitungTransaksi(this)" value="1" min="1"></td>
                <td class="harga-satuan">Rp 0</td>
                <td class="sub-total">Rp 0</td>
                <td><button class="btn btn-danger" onclick="hapusBarisKasir(this)">üóëÔ∏è</button></td>
            `;
        }

        function prosesScanKasir(btn) {
            const inputNama = btn.parentElement.querySelector(".input-kasir-nama");
            startScanner(inputNama, (kode) => {
                inputNama.value = kode;
                hitungTransaksi(inputNama);
            });
        }

        function hitungTransaksi(element) {
            const row = element.closest("tr");
            const inputUser = row.querySelector(".input-kasir-nama").value.toLowerCase().trim();
            const jumlah = parseInt(row.querySelector(".input-kasir-jumlah").value) || 0;

            const rowsMaster = document.querySelectorAll("#bodyTabel tr");
            let hargaDitemukan = 0;
            let namaAsli = "";

            rowsMaster.forEach((mRow) => {
                const namaTabel = mRow.cells[0].innerText.toLowerCase().trim();
                const hargaTabel = mRow.cells[1].innerText.replace(/[^0-9]/g, "");
                const kodeTabel = mRow.querySelector(".barcode-val") ? mRow.querySelector(".barcode-val").innerText.toLowerCase().trim() : "";

                if ((inputUser === namaTabel || inputUser === kodeTabel) && inputUser !== "") {
                    hargaDitemukan = parseInt(hargaTabel);
                    namaAsli = mRow.cells[0].innerText;
                }
            });

            if (namaAsli) row.querySelector(".input-kasir-nama").value = namaAsli;
            row.querySelector(".harga-satuan").innerText = "Rp " + hargaDitemukan.toLocaleString("id-ID");
            row.querySelector(".sub-total").innerText = "Rp " + (hargaDitemukan * jumlah).toLocaleString("id-ID");

            updateGrandTotal();
        }

        function updateGrandTotal() {
            let total = 0;
            document.querySelectorAll(".sub-total").forEach(st => {
                total += parseInt(st.innerText.replace(/[^0-9]/g, "")) || 0;
            });
            document.getElementById("grandTotal").innerText = "Rp " + total.toLocaleString("id-ID");
            hitungKembalian();
        }

        function hitungKembalian() {
            const total = parseInt(document.getElementById("grandTotal").innerText.replace(/[^0-9]/g, "")) || 0;
            const bayar = parseInt(document.getElementById("inputBayar").value) || 0;
            const kembalian = bayar - total;
            const el = document.getElementById("uangKembali");
            el.innerText = "Rp " + (kembalian < 0 ? 0 : kembalian).toLocaleString("id-ID");
            el.style.background = kembalian < 0 ? "#e74c3c" : "#2ecc71";
        }

        function hapusBarisKasir(btn) {
            btn.closest("tr").remove();
            updateGrandTotal();
        }

        // --- CETAK STRUK ---
        function cetakStrukIndomaret() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ unit: "mm", format: [80, 150] });
            let y = 10;
            doc.setFont("courier", "bold");
            doc.text("WARUNG CS", 40, y, { align: "center" });
            y += 10;
            document.querySelectorAll("#bodyKasir tr").forEach(row => {
                const nama = row.querySelector(".input-kasir-nama").value;
                const qty = row.querySelector(".input-kasir-jumlah").value;
                const sub = row.querySelector(".sub-total").innerText;
                if(nama) {
                    doc.setFontSize(8);
                    doc.text(`${nama} x${qty}`, 5, y);
                    doc.text(sub, 75, y, { align: "right" });
                    y += 5;
                }
            });
            doc.text("--------------------------", 40, y, { align: "center" });
            y += 5;
            doc.text("TOTAL: " + document.getElementById("grandTotal").innerText, 75, y, { align: "right" });
            doc.save("Struk.pdf");
        }

        window.onload = () => {
            const saved = localStorage.getItem("dataInventaris_V5");
            if (saved) document.getElementById("bodyTabel").innerHTML = saved;
            tambahBarisKasir();
        };
    </script>
</body>
</html>
