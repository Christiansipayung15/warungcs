<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warung CS - Kasir AI Pintar</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.min.js"></script>
    <script src="https://unpkg.com/ml5@latest/dist/ml5.min.js"></script>

    <style>
        body {
            background: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)),
              url("https://images.unsplash.com/photo-1534723452862-4c874018d66d?q=80&w=2070&auto=format&fit=crop");
            background-size: cover; background-position: center; background-attachment: fixed;
            font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; padding: 40px 20px; min-height: 100vh; margin: 0;
        }

        .container {
            background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(15px);
            padding: 30px; border-radius: 20px; box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.2); width: 100%; max-width: 950px; margin-bottom: 30px;
        }

        h2, h3 { color: white; text-align: center; text-transform: uppercase; letter-spacing: 2px; margin-top: 0; }
        
        .top-menu { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; border-bottom: 1px solid rgba(255, 255, 255, 0.2); padding-bottom: 15px; }

        .btn { padding: 10px 18px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.3s; font-size: 13px; display: flex; align-items: center; gap: 5px; }
        .btn-add { background: #2ecc71; color: white; }
        .btn-save { background: #f1c40f; color: #333; }
        .btn-edit { background: #3498db; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn:hover { transform: translateY(-2px); filter: brightness(1.1); }

        table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
        th { color: #eee; padding: 15px; text-align: left; }
        td { background: rgba(255, 255, 255, 0.95); padding: 12px 15px; color: #2c3e50; }
        td:first-child { border-radius: 10px 0 0 10px; }
        td:last-child { border-radius: 0 10px 10px 0; }

        input { width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ccc; }
        .total-box { background: #2ecc71; color: white; font-weight: bold; display: flex; align-items: center; justify-content: center; font-size: 18px; border-radius: 8px; height: 45px; width: 200px; }
        
        #video-container { border-radius: 15px; overflow: hidden; border: 3px solid #3498db; width: 320px; height: 240px; margin: 10px auto; background: #000; }
    </style>
</head>
<body>

    <div class="container" style="border: 2px solid #3498db">
        <h3>SCAN FOTO BARANG (AI)</h3>
        <div id="video-container"></div>
        
        <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-top: 15px;">
            <input type="text" id="aiNama" placeholder="Nama Barang..." style="width: 150px;">
            <input type="number" id="aiHarga" placeholder="Harga (Rp)..." style="width: 120px;">
            <button class="btn btn-add" onclick="latihDanSimpan()">üì∏ Rekam & Simpan</button>
            <button class="btn btn-save" onclick="mulaiTrainingAI()">üß† Proses Memori</button>
            <button class="btn btn-edit" onclick="mulaiScanOtomatis()">üîç Mulai Scan</button>
        </div>
        <p id="statusAI" style="color: white; text-align: center; font-size: 13px; margin-top: 15px;">Status: Memuat Kamera...</p>
    </div>

    <div class="container">
        <h2><u>WARUNG CS</u></h2>
        <div class="top-menu">
            <button class="btn btn-edit" onclick="aktifkanEditInventaris()">‚úèÔ∏è Edit Manual</button>
            <button class="btn btn-save" onclick="simpanDataInventaris()">üíæ Simpan Daftar</button>
        </div>

        <table id="tabelMaster">
            <thead>
                <tr>
                    <th>Nama Barang</th>
                    <th>Harga (Rp)</th>
                    <th>Kode</th>
                    <th>Aksi</th>
                </tr>
            </thead>
            <tbody id="bodyTabel">
                </tbody>
        </table>
    </div>

    <div class="container" style="border: 2px solid #f1c40f">
        <h3>RUANG KASIR</h3>
        <div class="top-menu">
            <button class="btn btn-add" onclick="tambahBarisKasir()">‚ûï Tambah Manual</button>
        </div>

        <table id="tabelKasir">
            <thead>
                <tr>
                    <th width="30%">Nama Barang</th>
                    <th width="15%">Jumlah</th>
                    <th width="20%">Harga</th>
                    <th width="20%">Total</th>
                    <th width="15%">Aksi</th>
                </tr>
            </thead>
            <tbody id="bodyKasir">
                <tr>
                    <td><input type="text" class="input-kasir-nama" oninput="hitungTransaksi(this)" placeholder="Hasil scan / ketik..."></td>
                    <td><input type="number" class="input-kasir-jumlah" oninput="hitungTransaksi(this)" value="1" min="1"></td>
                    <td class="harga-satuan">Rp 0</td>
                    <td class="sub-total">Rp 0</td>
                    <td><button class="btn btn-danger" onclick="hapusBarisKasir(this)">üóëÔ∏è</button></td>
                </tr>
            </tbody>
        </table>

        <div style="margin-top: 25px; display: flex; flex-direction: column; align-items: flex-end; gap: 10px;">
            <div style="display: flex; align-items: center; gap: 10px;">
                <span style="color:white">TOTAL:</span>
                <div id="grandTotal" class="total-box">Rp 0</div>
            </div>
        </div>
    </div>

    <script>
        let featureExtractor, classifier, video;

        // --- INISIALISASI P5JS & AI ---
        function setup() {
            let canvas = createCanvas(320, 240);
            canvas.parent('video-container');
            video = createCapture(VIDEO);
            video.size(320, 240);
            video.hide();

            featureExtractor = ml5.featureExtractor('MobileNet', () => {
                document.getElementById('statusAI').innerText = "Status: AI Siap! Rekam barang baru.";
            });
            classifier = featureExtractor.classification(video);
            
            muatDataInventaris();
        }

        function draw() {
            image(video, 0, 0, 320, 240);
        }

        // --- LOGIKA AI + AUTO SIMPAN ---
        function latihDanSimpan() {
            const nama = document.getElementById('aiNama').value;
            const harga = document.getElementById('aiHarga').value;

            if (!nama || !harga) return alert("Isi Nama dan Harga barang dulu!");

            // 1. Tambah ke AI
            classifier.addImage(nama);
            
            // 2. Tambah otomatis ke Tabel Inventaris
            tambahKeTabelInventaris(nama, harga);
            
            document.getElementById('statusAI').innerText = `Status: Foto ${nama} direkam & disimpan ke daftar!`;
        }

        function tambahKeTabelInventaris(nama, harga) {
            const body = document.getElementById("bodyTabel");
            const row = body.insertRow(-1);
            row.innerHTML = `
                <td>${nama}</td>
                <td>${harga}</td>
                <td>AI-${Math.floor(Math.random()*900)}</td>
                <td><button class="btn btn-danger" onclick="hapusBarisInventaris(this)">üóëÔ∏è</button></td>
            `;
            simpanDataInventaris(); // Langsung simpan ke LocalStorage
        }

        function mulaiTrainingAI() {
            document.getElementById('statusAI').innerText = "Status: AI sedang menghafal gambar...";
            classifier.train((lossValue) => {
                if (!lossValue) document.getElementById('statusAI').innerText = "Status: AI Selesai Menghafal!";
            });
        }

        function mulaiScanOtomatis() {
            classifier.classify((err, results) => {
                if (results && results[0].confidence > 0.8) {
                    const namaScan = results[0].label;
                    document.getElementById('statusAI').innerText = `Terdeteksi: ${namaScan}`;

                    let inputs = document.querySelectorAll(".input-kasir-nama");
                    let inputKosong = Array.from(inputs).find(i => i.value === "");
                    
                    let targetInput = inputKosong || inputs[inputs.length - 1];
                    targetInput.value = namaScan;
                    hitungTransaksi(targetInput);
                }
                setTimeout(mulaiScanOtomatis, 1000);
            });
        }

        // --- FUNGSI KASIR (DARI KODE LAMA ANDA) ---
        function hitungTransaksi(el) {
            const row = el.closest("tr");
            const namaIn = el.value.toLowerCase().trim();
            const qty = parseInt(row.querySelector(".input-kasir-jumlah").value) || 0;
            let harga = 0;

            document.querySelectorAll("#bodyTabel tr").forEach(r => {
                if(r.cells[0].innerText.toLowerCase() === namaIn) harga = parseInt(r.cells[1].innerText);
            });

            const sub = harga * qty;
            row.querySelector(".harga-satuan").innerText = "Rp " + harga.toLocaleString();
            row.querySelector(".sub-total").innerText = "Rp " + sub.toLocaleString();
            updateGrandTotal();
        }

        function updateGrandTotal() {
            let total = 0;
            document.querySelectorAll(".sub-total").forEach(s => total += parseInt(s.innerText.replace(/\D/g,'')) || 0);
            document.getElementById("grandTotal").innerText = "Rp " + total.toLocaleString();
        }

        function tambahBarisKasir() {
            const row = document.getElementById("bodyKasir").insertRow(-1);
            row.innerHTML = `<td><input type="text" class="input-kasir-nama" oninput="hitungTransaksi(this)"></td>
                             <td><input type="number" class="input-kasir-jumlah" oninput="hitungTransaksi(this)" value="1"></td>
                             <td class="harga-satuan">Rp 0</td><td class="sub-total">Rp 0</td>
                             <td><button class="btn btn-danger" onclick="hapusBarisKasir(this)">üóëÔ∏è</button></td>`;
        }

        function simpanDataInventaris() {
            localStorage.setItem("warung_cs_data", document.getElementById("bodyTabel").innerHTML);
        }

        function muatDataInventaris() {
            const data = localStorage.getItem("warung_cs_data");
            if(data) document.getElementById("bodyTabel").innerHTML = data;
        }

        function hapusBarisInventaris(btn) { btn.closest("tr").remove(); simpanDataInventaris(); }
        function hapusBarisKasir(btn) { btn.closest("tr").remove(); updateGrandTotal(); }
    </script>
</body>
</html>
