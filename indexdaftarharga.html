<!DOCTYPE html>
<html lang="id">
  <head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.min.js"></script>
<script src="https://unpkg.com/ml5@latest/dist/ml5.min.js"></script>

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sistem Toko & Kasir Pintar</title>
    <style>
      /* CSS Utama */
      body {
        background: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)),
          url("https://images.unsplash.com/photo-1534723452862-4c874018d66d?q=80&w=2070&auto=format&fit=crop");
        background-size: cover;
        background-position: center;
        background-attachment: fixed;
        font-family: "Segoe UI", sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 40px 20px;
        min-height: 100vh;
        margin: 0;
      }

      .container {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(15px);
        padding: 30px;
        border-radius: 20px;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
        border: 1px solid rgba(255, 255, 255, 0.2);
        width: 100%;
        max-width: 950px;
        margin-bottom: 30px;
      }

      h2, h3 {
        color: white;
        text-align: center;
        text-transform: uppercase;
        letter-spacing: 2px;
        margin-top: 0;
      }

      .top-menu {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        padding-bottom: 15px;
      }

      .btn {
        padding: 10px 18px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        transition: 0.3s;
        font-size: 13px;
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .btn-add { background: #2ecc71; color: white; }
      .btn-save { background: #f1c40f; color: #333; }
      .btn-edit { background: #3498db; color: white; }
      .btn-danger { background: #e74c3c; color: white; }

      .btn:hover {
        transform: translateY(-2px);
        filter: brightness(1.1);
      }

      table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0 8px;
      }

      th { color: #eee; padding: 15px; text-align: left; }
      td {
        background: rgba(255, 255, 255, 0.95);
        padding: 12px 15px;
        color: #2c3e50;
      }

      td:first-child { border-radius: 10px 0 0 10px; }
      td:last-child { border-radius: 0 10px 10px 0; }

      .locked td:not(:last-child) {
        background: rgba(200, 200, 200, 0.9);
        cursor: not-allowed;
      }

      input[type="text"], input[type="number"] {
        width: 100%;
        padding: 8px;
        border-radius: 5px;
        border: 1px solid #ccc;
        box-sizing: border-box;
      }

      .total-box {
        background: #2ecc71;
        color: white;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        border-radius: 8px;
        height: 45px;
        width: 200px;
      }

      .label-kasir { color: white; font-weight: bold; min-width: 150px; }
    </style>
  </head>
  <body>
    <div class="container" style="border: 2px solid #3498db">
  <h3>SCAN FOTO BARANG (AI)</h3>
  <div id="video-container" style="text-align: center; margin-bottom: 10px;">
    </div>
  
  <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
    <input type="text" id="labelBaru" placeholder="Nama Barang yg difoto..." style="width: 200px;">
    <button class="btn btn-add" onclick="latihBarang()">üì∏ Rekam Foto</button>
    <button class="btn btn-save" onclick="mulaiTraining()">üß† Proses Memori AI</button>
    <button class="btn btn-edit" onclick="mulaiScan()">üîç Mulai Scan Barang</button>
  </div>
  <p id="statusAI" style="color: white; text-align: center; font-size: 12px; margin-top: 10px;">Status: Menyiapkan Kamera...</p>
</div>




    <div class="container">
      <h2><u>WARUNG CS</u></h2>
      <div class="top-menu">
        <button class="btn btn-add" onclick="tambahBarisInventaris()">‚ûï Tambah Barang Baru</button>
        <button class="btn btn-save" onclick="simpanDataInventaris()">üíæ Simpan Daftar</button>
        <button class="btn btn-edit" onclick="aktifkanEditInventaris()">‚úèÔ∏è Edit Data</button>
      </div>

      <table id="tabelMaster">
        <thead>
          <tr>
            <th width="35%">Nama Barang</th>
            <th width="25%">Harga (Rp)</th>
            <th width="25%">No. Resi / Kode</th>
            <th width="15%">Aksi</th>
          </tr>
        </thead>
        <tbody id="bodyTabel" class="locked">
          </tbody>
      </table>
    </div>

    <div class="container" style="border: 2px solid #f1c40f">
      <h3>RUANG KASIR</h3>
      <div class="top-menu">
        <button class="btn btn-add" onclick="tambahBarisKasir()">‚ûï Tambah Belanjaan</button>
        <button class="btn" style="background: #e67e22; color: white" onclick="cetakStrukIndomaret()">üõí Cetak Struk</button>
      </div>

      <table id="tabelKasir">
        <thead>
          <tr>
            <th width="30%">Nama Barang</th>
            <th width="15%">Jumlah</th>
            <th width="20%">Harga Satuan</th>
            <th width="20%">Total</th>
            <th width="15%">Aksi</th>
          </tr>
        </thead>
        <tbody id="bodyKasir">
          <tr>
            <td><input type="text" class="input-kasir-nama" oninput="hitungTransaksi(this)" placeholder="Ketik nama barang..."></td>
            <td><input type="number" class="input-kasir-jumlah" oninput="hitungTransaksi(this)" value="1" min="1"></td>
            <td class="harga-satuan">Rp 0</td>
            <td class="sub-total">Rp 0</td>
            <td><button class="btn btn-danger" onclick="hapusBarisKasir(this)">üóëÔ∏èHapus</button></td>
          </tr>
        </tbody>
      </table>

      <div style="margin-top: 25px; display: flex; flex-direction: column; align-items: flex-end; gap: 10px;">
        <div style="display: flex; align-items: center; gap: 10px;">
          <span class="label-kasir">TOTAL BELANJA:</span>
          <div id="grandTotal" class="total-box">Rp 0</div>
        </div>
        <div style="display: flex; align-items: center; gap: 10px;">
          <span class="label-kasir">UANG BAYAR:</span>
          <input type="number" id="inputBayar" style="width: 200px; height: 45px; text-align: center; font-size: 18px; font-weight: bold;" oninput="hitungKembalian()" placeholder="0">
        </div>
        <div style="display: flex; align-items: center; gap: 10px;">
          <span class="label-kasir">KEMBALIAN:</span>
          <div id="uangKembali" class="total-box" style="background: #e74c3c;">Rp 0</div>
        </div>
      </div>
    </div>

    <script>
      let featureExtractor;
let classifier;
let video;
let loss;

// Inisialisasi Kamera dan AI
function setup() {
  // Membuat video di dalam div video-container
  const canvas = createCanvas(320, 240);
  canvas.parent('video-container');
  video = createCapture(VIDEO);
  video.size(320, 240);
  video.hide();

  // Memuat MobileNet (Model dasar AI)
  featureExtractor = ml5.featureExtractor('MobileNet', () => {
    document.getElementById('statusAI').innerText = "Status: AI Siap. Silakan rekam foto barang.";
  });
  
  // Membuat klasifikasi kustom
  classifier = featureExtractor.classification(video, () => {
    console.log("Video Ready");
  });
}

function draw() {
  image(video, 0, 0, 320, 240);
}

// 1. Fungsi untuk "Mengajari" AI
function latihBarang() {
  const nama = document.getElementById('labelBaru').value;
  if (!nama) return alert("Isi nama barang dulu!");
  
  classifier.addImage(nama);
  document.getElementById('statusAI').innerText = `Status: Menambah foto untuk ${nama}...`;
}

// 2. Fungsi untuk Memproses Memori (Training)
function mulaiTraining() {
  document.getElementById('statusAI').innerText = "Status: Sedang Berpikir (Training)... Mohon Tunggu";
  classifier.train((lossValue) => {
    if (lossValue) {
      loss = lossValue;
      document.getElementById('statusAI').innerText = `Status: Training... Loss: ${loss}`;
    } else {
      document.getElementById('statusAI').innerText = "Status: Selesai! AI sudah kenal barang Anda.";
    }
  });
}

// 3. Fungsi untuk Scan Otomatis
function mulaiScan() {
  classifier.classify((err, results) => {
    if (err) return console.error(err);
    
    if (results && results[0]) {
      const namaHasilScan = results[0].label;
      const keyakinan = Math.round(results[0].confidence * 100);
      
      document.getElementById('statusAI').innerText = `Terdeteksi: ${namaHasilScan} (${keyakinan}%)`;
      
      // Masukkan ke baris kasir terakhir
      const barisTerakhir = document.querySelector("#bodyKasir tr:last-child");
      const inputNama = barisTerakhir.querySelector(".input-kasir-nama");
      
      inputNama.value = namaHasilScan;
      hitungTransaksi(inputNama); // Jalankan fungsi hitung harga yang sudah Anda buat
    }
    
    // Scan berulang terus menerus
    setTimeout(mulaiScan, 1000);
  });
}
      // --- LOGIKA INVENTARIS ---
      function tambahBarisInventaris() {
        const body = document.getElementById("bodyTabel");
        body.classList.remove("locked");
        const row = body.insertRow(-1);
        row.innerHTML = `
          <td contenteditable="true"></td>
          <td contenteditable="true"></td>
          <td contenteditable="true"></td>
          <td><button class="btn btn-danger" onclick="hapusBarisInventaris(this)">üóëÔ∏è Hapus</button></td>
        `;
        row.cells[0].focus();
      }

      function hapusBarisInventaris(btn) {
        if(confirm("Hapus barang ini dari daftar?")) {
            btn.closest("tr").remove();
            simpanDataInventaris();
        }
      }

      function aktifkanEditInventaris() {
        const body = document.getElementById("bodyTabel");
        body.classList.remove("locked");
        body.querySelectorAll("td:not(:last-child)").forEach(td => td.setAttribute("contenteditable", "true"));
        alert("‚úèÔ∏è Mode Edit Aktif. Jangan lupa tekan Simpan jika sudah selesai.");
      }

      function simpanDataInventaris() {
        const body = document.getElementById("bodyTabel");
        // Kita simpan HTML-nya tapi pastikan mode edit dimatikan dulu
        body.querySelectorAll("td:not(:last-child)").forEach(td => td.setAttribute("contenteditable", "false"));
        body.classList.add("locked");
        localStorage.setItem("dataInventaris_V4", body.innerHTML);
        alert("‚úÖ Data inventaris berhasil disimpan!");
      }

      // --- LOGIKA KASIR ---
      function tambahBarisKasir() {
        const body = document.getElementById("bodyKasir");
        const row = body.insertRow(-1);
        row.innerHTML = `
          <td><input type="text" class="input-kasir-nama" oninput="hitungTransaksi(this)" placeholder="Nama barang..."></td>
          <td><input type="number" class="input-kasir-jumlah" oninput="hitungTransaksi(this)" value="1" min="1"></td>
          <td class="harga-satuan">Rp 0</td>
          <td class="sub-total">Rp 0</td>
          <td><button class="btn btn-danger" onclick="hapusBarisKasir(this)">üóëÔ∏è</button></td>
        `;
      }

      function hapusBarisKasir(btn) {
        const row = btn.closest("tr");
        const body = document.getElementById("bodyKasir");
        if (body.rows.length > 1) {
          row.remove();
        } else {
          row.querySelector(".input-kasir-nama").value = "";
          row.querySelector(".input-kasir-jumlah").value = 1;
          row.querySelector(".harga-satuan").innerText = "Rp 0";
          row.querySelector(".sub-total").innerText = "Rp 0";
        }
        updateGrandTotal();
      }

      function hitungTransaksi(element) {
        const row = element.closest("tr");
        const namaInput = row.querySelector(".input-kasir-nama").value.toLowerCase().trim();
        const jumlah = parseInt(row.querySelector(".input-kasir-jumlah").value) || 0;

        const rowsMaster = document.querySelectorAll("#bodyTabel tr");
        let hargaDitemukan = 0;

        rowsMaster.forEach((mRow) => {
          const namaTabel = mRow.cells[0].innerText.toLowerCase().trim();
          const hargaTabel = mRow.cells[1].innerText.replace(/[^0-9]/g, "");
          if (namaInput === namaTabel && namaInput !== "") {
            hargaDitemukan = parseInt(hargaTabel);
          }
        });

        const subTotal = hargaDitemukan * jumlah;
        row.querySelector(".harga-satuan").innerText = "Rp " + hargaDitemukan.toLocaleString("id-ID");
        row.querySelector(".sub-total").innerText = "Rp " + subTotal.toLocaleString("id-ID");

        updateGrandTotal();
      }

      function updateGrandTotal() {
        let totalSemua = 0;
        document.querySelectorAll(".sub-total").forEach((st) => {
          const nilai = parseInt(st.innerText.replace(/[^0-9]/g, "")) || 0;
          totalSemua += nilai;
        });
        document.getElementById("grandTotal").innerText = "Rp " + totalSemua.toLocaleString("id-ID");
        hitungKembalian();
      }

      function hitungKembalian() {
        const total = parseInt(document.getElementById("grandTotal").innerText.replace(/[^0-9]/g, "")) || 0;
        const bayar = parseInt(document.getElementById("inputBayar").value) || 0;
        const kembalian = bayar - total;
        
        const elemenKembali = document.getElementById("uangKembali");
        elemenKembali.innerText = "Rp " + (kembalian < 0 ? 0 : kembalian).toLocaleString("id-ID");
        elemenKembali.style.background = kembalian < 0 ? "#e74c3c" : "#2ecc71";
      }

      // --- CETAK STRUK ---
      function cetakStrukIndomaret() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ unit: "mm", format: [80, 150] });
        const lebarKertas = 80;
        const margin = 5;
        let y = 10;

        doc.setFont("courier", "bold");
        doc.setFontSize(12);
        doc.text("WARUNG CS", lebarKertas / 2, y, { align: "center" });
        y += 5;
        doc.setFontSize(8);
        doc.setFont("courier", "normal");
        doc.text("Kavling Kabil Indah Blok A6", lebarKertas / 2, y, { align: "center" });
        y += 7;
        doc.text(`Tgl : ${new Date().toLocaleString("id-ID")}`, margin, y);
        y += 4;
        doc.text("------------------------------------------", lebarKertas / 2, y, { align: "center" });
        y += 5;

        document.querySelectorAll("#bodyKasir tr").forEach((row) => {
          const nama = row.querySelector(".input-kasir-nama").value;
          const jumlah = row.querySelector(".input-kasir-jumlah").value;
          const harga = row.querySelector(".harga-satuan").innerText;
          const subtotal = row.querySelector(".sub-total").innerText;

          if (nama) {
            doc.text(nama.toUpperCase(), margin, y);
            y += 4;
            doc.text(`${jumlah} x ${harga}`, margin + 2, y);
            doc.text(subtotal, lebarKertas - margin, y, { align: "right" });
            y += 5;
          }
        });

        y += 2;
        doc.text("------------------------------------------", lebarKertas / 2, y, { align: "center" });
        y += 6;
        doc.setFont("courier", "bold");
        doc.text("TOTAL     :", margin, y);
        doc.text(document.getElementById("grandTotal").innerText, lebarKertas - margin, y, { align: "right" });
        y += 5;
        doc.text("TUNAI     :", margin, y);
        doc.text("Rp " + (parseInt(document.getElementById("inputBayar").value) || 0).toLocaleString("id-ID"), lebarKertas - margin, y, { align: "right" });
        y += 5;
        doc.text("KEMBALI   :", margin, y);
        doc.text(document.getElementById("uangKembali").innerText, lebarKertas - margin, y, { align: "right" });
        
        y += 10;
        doc.setFontSize(8);
        doc.text("TERIMA KASIH", lebarKertas / 2, y, { align: "center"
          
         });

     y += 5;
doc.setFont("courier", "bold");
doc.text("SELAMAT DATANG KEMBALI:>", lebarKertas / 2, y, { align: "center" });

y += 8;
doc.setFontSize(7);
doc.setFont("courier", "normal"); // Mengatur ke huruf biasa (tidak bold)
doc.text("barang yang sudah dibeli", lebarKertas / 2, y, { align: "center" }); // Huruf kecil

y += 4;
doc.text("tidak dapat ditukar/dikembalikan", lebarKertas / 2, y, { align: "center" }); // Huruf kecil
        doc.save(`STRUK_${Date.now()}.pdf`);
      }

      window.onload = function () {
        const saved = localStorage.getItem("dataInventaris_V4");
        const body = document.getElementById("bodyTabel");
        if (saved) {
          body.innerHTML = saved;
        } else {
          // Data default jika kosong
          body.innerHTML = `
            <tr>
              <td contenteditable="false">Beras</td>
              <td contenteditable="false">15000</td>
              <td contenteditable="false">001</td>
              <td><button class="btn btn-danger" onclick="hapusBarisInventaris(this)">üóëÔ∏è Hapus</button></td>
            </tr>
          `;
        }
      };
    </script>
  </body>
</html>
